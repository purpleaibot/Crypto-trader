import pandas_ta as ta
import pandas as pd
import logging

logger = logging.getLogger(__name__)

class Strategy:
    def __init__(self):
        pass

    def calculate_indicators(self, df, indicators_config=None):
        """
        Adds technical indicators to the DataFrame.
        If indicators_config is provided, it calculates only those with specific params.
        """
        if not indicators_config:
            # Default/Legacy indicators for badges
            df['EMA_10'] = ta.ema(df['close'], length=10)
            df['EMA_20'] = ta.ema(df['close'], length=20)
            df['EMA_50'] = ta.ema(df['close'], length=50)
            df['EMA_200'] = ta.ema(df['close'], length=200)
            df['SMA_20'] = ta.sma(df['close'], length=20)
            df['RSI'] = ta.rsi(df['close'], length=14)
            macd = ta.macd(df['close'])
            if macd is not None: df = pd.concat([df, macd], axis=1)
            adx = ta.adx(df['high'], df['low'], df['close'], length=14)
            if adx is not None: df = pd.concat([df, adx], axis=1)
            df['ATR'] = ta.atr(df['high'], df['low'], df['close'], length=14)
            bb = ta.bbands(df['close'], length=20, std=2)
            if bb is not None: df = pd.concat([df, bb], axis=1)
            try:
                ichi = ta.ichimoku(df['high'], df['low'], df['close'])[0]
                df = pd.concat([df, ichi], axis=1)
            except: pass
            if 'volume' in df.columns: df['VWAP'] = ta.vwap(df['high'], df['low'], df['close'], df['volume'])
            return df

        # Dynamic V2 Calculation
        for ind in indicators_config:
            name = ind['name']
            params = ind.get('params', {})
            source_col = params.get('source', 'close')
            source = df[source_col] if source_col in df.columns else df['close']

            try:
                if name == "EMA":
                    length = int(params.get('length', 20))
                    df[f"EMA_{length}"] = ta.ema(source, length=length)
                elif name == "SMA":
                    length = int(params.get('length', 20))
                    df[f"SMA_{length}"] = ta.sma(source, length=length)
                elif name == "RSI":
                    length = int(params.get('length', 14))
                    df[f"RSI_{length}"] = ta.rsi(source, length=length)
                elif name == "MACD":
                    fast = int(params.get('fast', 12))
                    slow = int(params.get('slow', 26))
                    signal = int(params.get('signal', 9))
                    macd = ta.macd(source, fast=fast, slow=slow, signal=signal)
                    df = pd.concat([df, macd], axis=1)
                elif name == "Ichimoku":
                    tenkan = int(params.get('tenkan', 9))
                    kijun = int(params.get('kijun', 26))
                    senkou = int(params.get('senkou', 52))
                    ichi = ta.ichimoku(df['high'], df['low'], df['close'], tenkan=tenkan, kijun=kijun, senkou=senkou)[0]
                    df = pd.concat([df, ichi], axis=1)
                elif name == "Vortex":
                    length = int(params.get('length', 14))
                    vortex = ta.vortex(df['high'], df['low'], df['close'], length=length)
                    df = pd.concat([df, vortex], axis=1)
                elif name == "LinReg Slope":
                    length = int(params.get('length', 14))
                    df[f"SLOPE_{length}"] = ta.slope(source, length=length)
                elif name == "TTM Squeeze":
                    # Standard TTM Squeeze using KC and BB
                    squeeze = ta.squeeze(df['high'], df['low'], df['close'])
                    if squeeze is not None: df = pd.concat([df, squeeze], axis=1)
                elif name == "Chaikin Money Flow":
                    length = int(params.get('length', 20))
                    df[f"CMF_{length}"] = ta.cmf(df['high'], df['low'], df['close'], df['volume'], length=length)
                elif name == "ADX":
                    length = int(params.get('length', 14))
                    adx = ta.adx(df['high'], df['low'], df['close'], length=length)
                    df = pd.concat([df, adx], axis=1)
                elif name == "ATR":
                    length = int(params.get('length', 14))
                    df[f"ATR_{length}"] = ta.atr(df['high'], df['low'], df['close'], length=length)
            except Exception as e:
                logger.error(f"Error calculating {name}: {e}")

        return df

    def evaluate_alignment(self, df, indicators_config):
        """
        NEW V2 Logic: Checks if ALL selected components align in direction.
        Returns 'BUY' if all uptrend, 'SELL' if all downtrend, else None.
        """
        if not indicators_config: return None
        
        last = df.iloc[-1]
        results = [] # List of 'UP', 'DOWN', or 'NEUTRAL'

        for ind in indicators_config:
            name = ind['name']
            components = ind.get('selected_components', [])
            params = ind.get('params', {})
            
            for comp in components:
                direction = 'NEUTRAL'
                try:
                    if name == "EMA":
                        length = params.get('length', 20)
                        val = last.get(f"EMA_{length}")
                        if val: direction = 'UP' if last['close'] > val else 'DOWN'
                    
                    elif name == "RSI":
                        length = params.get('length', 14)
                        val = last.get(f"RSI_{length}")
                        if val: direction = 'UP' if val > 50 else 'DOWN'

                    elif name == "Vortex":
                        vip = last.get(f"VTXP_{params.get('length', 14)}")
                        vin = last.get(f"VTXM_{params.get('length', 14)}")
                        if vip and vin: direction = 'UP' if vip > vin else 'DOWN'

                    elif name == "LinReg Slope":
                        val = last.get(f"SLOPE_{params.get('length', 14)}")
                        if val: direction = 'UP' if val > 0 else 'DOWN'

                    elif name == "Chaikin Money Flow":
                        val = last.get(f"CMF_{params.get('length', 20)}")
                        if val: direction = 'UP' if val > 0 else 'DOWN'

                    elif name == "Ichimoku":
                        # Component: 'Cloud', 'Tenkan/Kijun', 'Price/Base'
                        if comp == 'Cloud':
                            span_a = last.get(f"ISA_{params.get('tenkan', 9)}")
                            span_b = last.get(f"ISB_{params.get('kijun', 26)}")
                            if span_a and span_b: direction = 'UP' if last['close'] > max(span_a, span_b) else 'DOWN' if last['close'] < min(span_a, span_b) else 'NEUTRAL'
                        elif comp == 'Tenkan/Kijun':
                            its = last.get(f"ITS_{params.get('tenkan', 9)}")
                            iks = last.get(f"IKS_{params.get('kijun', 26)}")
                            if its and iks: direction = 'UP' if its > iks else 'DOWN'

                    # Add more component logic as needed...
                except: pass
                results.append(direction)

        if all(r == 'UP' for r in results) and results: return 'BUY'
        if all(r == 'DOWN' for r in results) and results: return 'SELL'
        return None

    def evaluate_dynamic_rules(self, df, rules):
        """
        Evaluates a list of logical rules against the dataframe.
        Returns True if ALL rules pass (AND logic).
        """
        if not rules: return True # No rules = Pass (or handle as False?)
        
        last_row = df.iloc[-1]
        prev_row = df.iloc[-2]
        
        for rule in rules:
            try:
                # 1. Get Value A
                # Handle basic indicators mappings
                ind_a = self._map_indicator_name(rule['a'], rule.get('pa'))
                val_a = last_row.get(ind_a)
                prev_val_a = prev_row.get(ind_a)
                
                # 2. Get Value B
                if rule['target'] == 'value':
                    val_b = float(rule['val'])
                    prev_val_b = val_b
                else:
                    ind_b = self._map_indicator_name(rule['b'], rule.get('pb'))
                    val_b = last_row.get(ind_b)
                    prev_val_b = prev_row.get(ind_b)

                if val_a is None or val_b is None:
                    return False

                # 3. Compare based on Operator
                op = rule['op']
                if op == '>':
                    if not (val_a > val_b): return False
                elif op == '<':
                    if not (val_a < val_b): return False
                elif op == 'equals':
                    if not (val_a == val_b): return False
                elif op == 'crosses above':
                    # (Prev A <= Prev B) AND (Curr A > Curr B)
                    if not (prev_val_a <= prev_val_b and val_a > val_b): return False
                elif op == 'crosses below':
                    # (Prev A >= Prev B) AND (Curr A < Curr B)
                    if not (prev_val_a >= prev_val_b and val_a < val_b): return False
                    
            except Exception as e:
                logger.error(f"Rule evaluation error: {rule} -> {e}")
                return False
                
        return True

    def _map_indicator_name(self, name, param):
        """Helper to map UI names to Pandas TA column names"""
        # Defaults if param empty
        p = param if param else "14"
        
        if name == "RSI": return f"RSI_{p}" if f"RSI_{p}" in ["RSI_14"] else "RSI" # Fallback simplified
        if name == "EMA": return f"EMA_{p}"
        if name == "SMA": return f"SMA_{p}"
        if name == "ADX": return f"ADX_{p}"
        if name == "ATR": return f"ATR_{p}"
        if name == "VWAP": return "VWAP_D" # Standard daily VWAP
        # Add more mappings as needed
        return name

    def check_dynamic_signal(self, data_map, strategy_logic, timeframes):
        """
        Evaluates the full strategy logic from the UI configuration.
        Supports V1 (Legacy) and V2 (Alignment).
        """
        version = strategy_logic.get('version', '1.0')

        if version == '2.0':
            # V2: Global Alignment Logic
            # ALL selected components on ALL timeframes must align.
            results = []
            for tf_key in ['large', 'med', 'small']:
                if tf_key in strategy_logic:
                    # Map 'large' to timeframe[2], etc. (assuming 3 TFs)
                    # This is slightly brittle but matches current UI assumptions.
                    # BETTER: Use tf index from config.
                    tf_idx = 2 if tf_key == 'large' else 1 if tf_key == 'med' else 0
                    if len(timeframes) > tf_idx:
                        tf = timeframes[tf_idx]
                        if tf in data_map:
                            res = self.evaluate_alignment(data_map[tf], strategy_logic[tf_key])
                            if res: results.append(res)
                            else: return None # Disconnect: One TF has no alignment
            
            # Final Check: Do all TFs that had rules agree?
            if results and all(r == 'BUY' for r in results): return 'BUY'
            if results and all(r == 'SELL' for r in results): return 'SELL'
            return None

        else:
            # V1: Legacy Indicator vs Indicator Logic
            trend_aligned = True
            if len(timeframes) >= 3 and strategy_logic.get('large'):
                tf_large = timeframes[2]
                if tf_large in data_map:
                    if not self.evaluate_dynamic_rules(data_map[tf_large], strategy_logic['large']):
                        trend_aligned = False
            if len(timeframes) >= 2 and strategy_logic.get('med'):
                tf_med = timeframes[1]
                if tf_med in data_map:
                    if not self.evaluate_dynamic_rules(data_map[tf_med], strategy_logic['med']):
                        trend_aligned = False
            if not trend_aligned: return None
            tf_small = timeframes[0]
            if tf_small in data_map and strategy_logic.get('small'):
                if self.evaluate_dynamic_rules(data_map[tf_small], strategy_logic['small']):
                    return "BUY"
            return None

    def check_trend(self, df_1d, df_4h):
        """
        Checks if the higher timeframes are aligned.
        Returns: 'UP', 'DOWN', or 'NEUTRAL'
        """
        # Get last closed candle
        last_1d = df_1d.iloc[-1]
        last_4h = df_4h.iloc[-1]
        
        # Define Trend Criteria
        # 1. Price vs EMAs
        # 2. EMA Cross
        # 3. ADX Strength (>20)
        # 4. +DI vs -DI
        
        # Check 1D Trend
        trend_1d = self._evaluate_trend(last_1d)
        
        # Check 4H Trend
        trend_4h = self._evaluate_trend(last_4h)
        
        if trend_1d == 'UP' and trend_4h == 'UP':
            return 'UP'
        elif trend_1d == 'DOWN' and trend_4h == 'DOWN':
            return 'DOWN'
        else:
            return 'NEUTRAL'

    def _evaluate_trend(self, row):
        """
        Helper to evaluate a single row's trend.
        """
        adx_threshold = 20
        
        # Check if indicators exist (UI safety check)
        if 'EMA_50' not in row or 'EMA_200' not in row or 'ADX_14' not in row:
            return 'NEUTRAL'
            
        # Uptrend Condition
        if (row['close'] > row['EMA_50'] > row['EMA_200'] and
            row['ADX_14'] > adx_threshold and
            row['DMP_14'] > row['DMN_14']):
            return 'UP'
            
        # Downtrend Condition
        if (row['close'] < row['EMA_50'] < row['EMA_200'] and
            row['ADX_14'] > adx_threshold and
            row['DMN_14'] > row['DMP_14']):
            return 'DOWN'
            
        return 'NEUTRAL'

    def get_row_trend(self, row):
        """Public wrapper for UI trend display"""
        return self._evaluate_trend(row)

    def check_trigger(self, df_1h, trend_direction):
        """
        Checks for entry triggers on lower timeframe (1H) aligned with Trend.
        Returns: 'BUY', 'SELL', or None
        """
        last_row = df_1h.iloc[-1]
        prev_row = df_1h.iloc[-2] # To check for crossover
        
        # Volatility Filter (ATR)
        # TODO: Define a dynamic threshold based on asset price or %?
        # For now, ensuring it's not zero/null.
        if last_row['ATR'] == 0:
            return None

        if trend_direction == 'UP':
            # Buy Trigger: EMA 10 crosses ABOVE EMA 20 AND RSI is rising/bullish
            if (prev_row['EMA_10'] <= prev_row['EMA_20'] and 
                last_row['EMA_10'] > last_row['EMA_20'] and
                last_row['RSI'] > 40): # RSI check
                return 'BUY'
                
        elif trend_direction == 'DOWN':
            # Sell Trigger: EMA 10 crosses BELOW EMA 20 AND RSI is falling/bearish
            if (prev_row['EMA_10'] >= prev_row['EMA_20'] and 
                last_row['EMA_10'] < last_row['EMA_20'] and
                last_row['RSI'] < 60): # RSI check
                return 'SELL'
                
        return None
